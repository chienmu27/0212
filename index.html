
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åœ˜å ±åæŸ¥è©¢ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto+Sans+TC', sans-serif;
            background-color: #f8fafc;
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState } from 'react';
        import ReactDOM from 'react-dom';
        import { Search, Trash2, ClipboardList, Info, AlertCircle, CheckCircle2, Loader2 } from 'lucide-react';

        // --- è¨­å®šå€ ---
        const SPREADSHEET_ID = '17gOPXFMR1UzS5NHOE7MV6Jbfzo1blDnkmjBksSdpCvk';
        const SHEET_NAME = 'è¡¨å–®å›æ‡‰ 1';
        
        // è«‹ç¢ºä¿æ­¤è™•ç‚ºæ‚¨æœ€æ–°çš„ GAS éƒ¨ç½²ç¶²å€
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyrhvVgOr4tI_3PtQDJJGthYbPYdgbss3MqbxmXz9B_w_sC-0SA2B4Kk0muZ_e93DlVkA/exec';

        const App = () => {
            const [phoneNumber, setPhoneNumber] = useState('');
            const [results, setResults] = useState([]);
            const [status, setStatus] = useState('IDLE'); 
            const [message, setMessage] = useState('');

            const formatClubName = (fullName) => {
                if (!fullName) return '';
                return fullName.split('(')[0].trim();
            };

            const handleSearch = async (e) => {
                if (e) e.preventDefault();
                if (!phoneNumber.trim()) {
                    setMessage('è«‹è¼¸å…¥å®Œæ•´çš„æ‰‹æ©Ÿè™Ÿç¢¼');
                    return;
                }

                setStatus('LOADING');
                setMessage('');
                
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
                    const response = await fetch(url);
                    const text = await response.text();
                    const jsonData = JSON.parse(text.substring(47, text.length - 2));
                    
                    const rows = jsonData.table.rows;
                    const records = rows.map((row, index) => {
                        const c = row.c;
                        return {
                            rowId: index + 1,
                            timestamp: c[0]?.v || '',
                            email: c[1]?.v || '',
                            clubItem: c[2]?.v || '',
                            displayClubItem: formatClubName(c[2]?.v || ''),
                            grade: c[3]?.v || '',
                            className: c[4]?.v || '',
                            seatNumber: c[5]?.v || '',
                            studentName: c[6]?.v || '',
                            phoneNumber: String(c[7]?.v || '')
                        };
                    });

                    const filtered = records.filter(r => r.phoneNumber === phoneNumber.trim());
                    setResults(filtered);
                    
                    if (filtered.length === 0) {
                        setMessage('æŸ¥ç„¡æ­¤æ‰‹æ©Ÿè™Ÿç¢¼çš„å ±åç´€éŒ„ã€‚');
                    }
                    setStatus('SUCCESS');
                } catch (error) {
                    console.error('Fetch error:', error);
                    setStatus('ERROR');
                    setMessage('è®€å–è©¦ç®—è¡¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚');
                }
            };

            const handleDelete = async (record) => {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${record.studentName}ã€çš„ã€Œ${record.displayClubItem}ã€å ±åç´€éŒ„å—ï¼Ÿ`)) {
                    return;
                }

                setStatus('LOADING');
                try {
                    // é‡è¦ä¿®æ­£ï¼šç§»é™¤ headers ä»¥é¿å… CORS é æª¢å¤±æ•—
                    // mode: 'no-cors' é…åˆç°¡å–®è«‹æ±‚ï¼Œé›–ç„¶ç„¡æ³•è®€å–å›å‚³å€¼ï¼Œä½†èƒ½æˆåŠŸé€é” GAS
                    await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            action: 'delete',
                            timestamp: String(record.timestamp),
                            phoneNumber: record.phoneNumber,
                            studentName: record.studentName
                        })
                    });
                    
                    // æ¨‚è§€æ›´æ–°ä»‹é¢
                    setResults(prev => prev.filter(r => r.timestamp !== record.timestamp || r.studentName !== record.studentName));
                    alert('åˆªé™¤è«‹æ±‚å·²é€å‡ºï¼è‹¥è³‡æ–™æœªæ¶ˆå¤±ï¼Œè«‹ç¨å€™å¹¾ç§’å†é‡æ–°æŸ¥è©¢ã€‚');
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('é€£ç·šè‡³åˆªé™¤æœå‹™å¤±æ•—ã€‚');
                }
                setStatus('SUCCESS');
            };

            return React.createElement('div', { className: 'min-h-screen pb-12' }, [
                React.createElement('header', { className: 'bg-blue-600 text-white shadow-lg mb-8' }, 
                    React.createElement('div', { className: 'max-w-4xl mx-auto px-4 py-10 text-center' }, [
                        React.createElement('h1', { className: 'text-3xl font-bold tracking-tight mb-2' }, 'ç¤¾åœ˜å ±åæŸ¥è©¢ç³»çµ±'),
                        React.createElement('p', { className: 'text-blue-100 opacity-90' }, 'è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼é€²è¡Œè³‡æ–™ç®¡ç†')
                    ])
                ),

                React.createElement('main', { className: 'max-w-4xl mx-auto px-4' }, [
                    React.createElement('div', { className: 'bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8' }, 
                        React.createElement('form', { onSubmit: handleSearch, className: 'flex flex-col md:flex-row gap-4' }, [
                            React.createElement('div', { className: 'relative flex-grow' }, 
                                React.createElement('input', {
                                    type: 'tel',
                                    placeholder: 'æ‰‹æ©Ÿè™Ÿç¢¼ (ä¾‹å¦‚: 0912345678)',
                                    value: phoneNumber,
                                    onChange: (e) => setPhoneNumber(e.target.value),
                                    className: 'block w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-lg'
                                })
                            ),
                            React.createElement('button', {
                                type: 'submit',
                                disabled: status === 'LOADING',
                                className: 'px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition-colors disabled:opacity-50'
                            }, status === 'LOADING' ? 'è™•ç†ä¸­...' : 'æŸ¥è©¢ç´€éŒ„')
                        ])
                    ),

                    message && React.createElement('div', { className: `mb-8 p-4 rounded-xl flex items-center gap-3 ${status === 'ERROR' ? 'bg-red-50 text-red-700' : 'bg-blue-50 text-blue-700'}` }, [
                        React.createElement(Info, { size: 20 }),
                        React.createElement('p', { className: 'font-medium' }, message)
                    ]),

                    results.length > 0 && React.createElement('div', { className: 'space-y-4' }, [
                        React.createElement('h2', { className: 'text-xl font-bold text-slate-800 mb-4' }, `æ‰¾åˆ° ${results.length} ç­†ç´€éŒ„`),
                        ...results.map((record, i) => 
                            React.createElement('div', { key: i, className: 'bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col md:flex-row md:items-center justify-between gap-4' }, [
                                React.createElement('div', null, [
                                    React.createElement('div', { className: 'flex items-center gap-2 mb-1' }, [
                                        React.createElement('span', { className: 'bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded' }, `${record.grade}å¹´${record.className}ç­`),
                                        React.createElement('h3', { className: 'text-lg font-bold' }, record.studentName)
                                    ]),
                                    React.createElement('p', { className: 'text-slate-600' }, [
                                        React.createElement('span', { className: 'text-slate-400 mr-2' }, 'å ±åé …ç›®:'),
                                        React.createElement('span', { className: 'text-blue-600 font-bold text-xl' }, record.displayClubItem)
                                    ]),
                                    React.createElement('p', { className: 'text-xs text-slate-400 mt-2' }, `å ±åæ™‚é–“ï¼š${record.timestamp}`)
                                ]),
                                React.createElement('button', {
                                    onClick: () => handleDelete(record),
                                    className: 'flex items-center justify-center gap-2 px-4 py-2 bg-red-50 text-red-600 hover:bg-red-100 font-medium rounded-lg transition-colors border border-red-100'
                                }, [
                                    React.createElement(Trash2, { size: 16 }),
                                    'åˆªé™¤è³‡æ–™'
                                ])
                            ])
                        )
                    ])
                ]),

                React.createElement('footer', { className: 'max-w-4xl mx-auto px-4 mt-12' }, 
                    React.createElement('div', { className: 'bg-slate-800 text-slate-300 p-6 rounded-2xl text-sm' }, [
                        React.createElement('h4', { className: 'font-bold text-white mb-2' }, 'ğŸ’¡ æç¤º'),
                        React.createElement('ul', { className: 'list-disc list-inside space-y-1' }, [
                            React.createElement('li', null, 'å¦‚åŸ·è¡Œåˆªé™¤å¾Œè³‡æ–™æœªå³æ™‚æ›´æ–°ï¼Œè«‹é‡æ–°æŸ¥è©¢ã€‚'),
                            React.createElement('li', null, 'è«‹ç¢ºä¿æ‚¨çš„ Google Apps Script å·²éƒ¨ç½²ç‚ºã€Œä»»ä½•äººã€çš†å¯å­˜å–ã€‚')
                        ])
                    ])
                )
            ]);
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>

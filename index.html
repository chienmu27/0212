
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åœ˜å ±åæŸ¥è©¢ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto+Sans+TC', sans-serif;
            background-color: #f8fafc;
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState } from 'react';
        import ReactDOM from 'react-dom';
        import { Search, Trash2, ClipboardList, Info, AlertCircle, CheckCircle2, Loader2 } from 'lucide-react';

        // --- è¨­å®šå€ ---
        const SPREADSHEET_ID = '17gOPXFMR1UzS5NHOE7MV6Jbfzo1blDnkmjBksSdpCvk';
        const SHEET_NAME = 'è¡¨å–®å›æ‡‰ 1';
        
        /** 
         * è‹¥è¦å•Ÿç”¨åˆªé™¤åŠŸèƒ½ï¼Œè«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€ 
         * è…³æœ¬ç¯„ä¾‹è¦‹ä¸‹æ–¹è¨»é‡‹
         */
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby-14hjeqG2pf452I0uPUPDjpA2-cRMy_5N1FzCCdN5pXgagLha5oJkHCuNvzREUIVEYw/exec';

        const App = () => {
            const [phoneNumber, setPhoneNumber] = useState('');
            const [results, setResults] = useState([]);
            const [status, setStatus] = useState('IDLE'); // IDLE, LOADING, SUCCESS, ERROR
            const [message, setMessage] = useState('');

            // æ ¼å¼åŒ–ç¤¾åœ˜åç¨±ï¼šå– ( å·¦é‚Šçš„æ–‡å­—
            const formatClubName = (fullName) => {
                if (!fullName) return '';
                return fullName.split('(')[0].trim();
            };

            const handleSearch = async (e) => {
                if (e) e.preventDefault();
                if (!phoneNumber.trim()) {
                    setMessage('è«‹è¼¸å…¥å®Œæ•´çš„æ‰‹æ©Ÿè™Ÿç¢¼');
                    return;
                }

                setStatus('LOADING');
                setMessage('');
                
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
                    const response = await fetch(url);
                    const text = await response.text();
                    // ç§»é™¤ Google å›å‚³çš„ JSON å°è£å‰ç¶´
                    const jsonData = JSON.parse(text.substring(47, text.length - 2));
                    
                    const rows = jsonData.table.rows;
                    const records = rows.map((row, index) => {
                        const c = row.c;
                        return {
                            rowId: index + 1, // è©¦ç®—è¡¨è¡Œè™Ÿ
                            timestamp: c[0]?.v || '',
                            email: c[1]?.v || '',
                            clubItem: c[2]?.v || '',
                            displayClubItem: formatClubName(c[2]?.v || ''),
                            grade: c[3]?.v || '',
                            className: c[4]?.v || '',
                            seatNumber: c[5]?.v || '',
                            studentName: c[6]?.v || '',
                            phoneNumber: String(c[7]?.v || '')
                        };
                    });

                    const filtered = records.filter(r => r.phoneNumber === phoneNumber.trim());
                    setResults(filtered);
                    
                    if (filtered.length === 0) {
                        setMessage('æŸ¥ç„¡æ­¤æ‰‹æ©Ÿè™Ÿç¢¼çš„å ±åç´€éŒ„ï¼Œè«‹ç¢ºèªè™Ÿç¢¼æ˜¯å¦æ­£ç¢ºã€‚');
                    }
                    setStatus('SUCCESS');
                } catch (error) {
                    console.error('Fetch error:', error);
                    setStatus('ERROR');
                    setMessage('è®€å–è©¦ç®—è¡¨å¤±æ•—ï¼Œè«‹ç¢ºèªè©²è©¦ç®—è¡¨æ˜¯å¦å·²è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„äººçš†å¯æŸ¥çœ‹ã€ã€‚');
                }
            };

            const handleDelete = async (record) => {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${record.studentName}ã€çš„ã€Œ${record.displayClubItem}ã€å ±åç´€éŒ„å—ï¼Ÿ`)) {
                    return;
                }

                if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL.includes('YOUR_GAS')) {
                    alert('ç³»çµ±æç¤ºï¼šå°šæœªè¨­å®šå¾Œç«¯åˆªé™¤è…³æœ¬(GAS)ã€‚æ­¤æŒ‰éˆ•ç›®å‰åƒ…ç‚ºä»‹é¢å±•ç¤ºï¼Œç„¡æ³•å¯¦éš›åˆªé™¤è©¦ç®—è¡¨è³‡æ–™ã€‚');
                    return;
                }

                setStatus('LOADING');
                try {
                    // ä½¿ç”¨ POST ç™¼é€åˆªé™¤è«‹æ±‚çµ¦ GAS
                    await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'delete',
                            timestamp: record.timestamp,
                            phoneNumber: record.phoneNumber
                        })
                    });
                    
                    // ç§»é™¤ç•«é¢ä¸Šè©²ç­†è³‡æ–™
                    setResults(prev => prev.filter(r => r.timestamp !== record.timestamp));
                    alert('åˆªé™¤è«‹æ±‚å·²é€å‡ºï¼Œè³‡æ–™ç¨å¾Œå°‡æœƒæ›´æ–°ã€‚');
                } catch (error) {
                    alert('é€£ç·šè‡³åˆªé™¤æœå‹™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è…³æœ¬è¨­å®šã€‚');
                }
                setStatus('SUCCESS');
            };

            return React.createElement('div', { className: 'min-h-screen pb-12' }, [
                // Header
                React.createElement('header', { className: 'bg-blue-600 text-white shadow-lg mb-8' }, 
                    React.createElement('div', { className: 'max-w-4xl mx-auto px-4 py-10 text-center' }, [
                        React.createElement('h1', { className: 'text-3xl font-bold tracking-tight mb-2' }, 'ç¤¾åœ˜å ±åæŸ¥è©¢ç³»çµ±'),
                        React.createElement('p', { className: 'text-blue-100 opacity-90' }, 'è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢æ‚¨çš„å ±åç‹€æ³')
                    ])
                ),

                // Main Content
                React.createElement('main', { className: 'max-w-4xl mx-auto px-4' }, [
                    // Search Bar
                    React.createElement('div', { className: 'bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8' }, 
                        React.createElement('form', { onSubmit: handleSearch, className: 'flex flex-col md:flex-row gap-4' }, [
                            React.createElement('div', { className: 'relative flex-grow' }, 
                                React.createElement('input', {
                                    type: 'tel',
                                    placeholder: 'æ‰‹æ©Ÿè™Ÿç¢¼ (ä¾‹å¦‚: 0912345678)',
                                    value: phoneNumber,
                                    onChange: (e) => setPhoneNumber(e.target.value),
                                    className: 'block w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-lg'
                                })
                            ),
                            React.createElement('button', {
                                type: 'submit',
                                disabled: status === 'LOADING',
                                className: 'px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition-colors disabled:opacity-50'
                            }, status === 'LOADING' ? 'è™•ç†ä¸­...' : 'æŸ¥è©¢ç´€éŒ„')
                        ])
                    ),

                    // Message Area
                    message && React.createElement('div', { className: `mb-8 p-4 rounded-xl flex items-center gap-3 ${status === 'ERROR' ? 'bg-red-50 text-red-700' : 'bg-blue-50 text-blue-700'}` }, [
                        React.createElement(Info, { size: 20 }),
                        React.createElement('p', { className: 'font-medium' }, message)
                    ]),

                    // Results
                    results.length > 0 && React.createElement('div', { className: 'space-y-4' }, [
                        React.createElement('h2', { className: 'text-xl font-bold text-slate-800 mb-4' }, `æ‰¾åˆ° ${results.length} ç­†ç´€éŒ„`),
                        ...results.map((record, i) => 
                            React.createElement('div', { key: i, className: 'bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col md:flex-row md:items-center justify-between gap-4' }, [
                                React.createElement('div', null, [
                                    React.createElement('div', { className: 'flex items-center gap-2 mb-1' }, [
                                        React.createElement('span', { className: 'bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded' }, `${record.grade}${record.className}`),
                                        React.createElement('h3', { className: 'text-lg font-bold' }, record.studentName)
                                    ]),
                                    React.createElement('p', { className: 'text-slate-600' }, [
                                        React.createElement('span', { className: 'text-slate-400 mr-2' }, 'å ±åé …ç›®:'),
                                        React.createElement('span', { className: 'text-blue-600 font-bold text-xl' }, record.displayClubItem)
                                    ]),
                                    React.createElement('p', { className: 'text-xs text-slate-400 mt-2' }, `å ±åæ™‚é–“ï¼š${record.timestamp}`)
                                ]),
                                React.createElement('button', {
                                    onClick: () => handleDelete(record),
                                    className: 'flex items-center justify-center gap-2 px-4 py-2 bg-red-50 text-red-600 hover:bg-red-100 font-medium rounded-lg transition-colors border border-red-100'
                                }, [
                                    React.createElement(Trash2, { size: 16 }),
                                    'åˆªé™¤è³‡æ–™'
                                ])
                            ])
                        )
                    ])
                ]),

                // Footer / Instructions
                React.createElement('footer', { className: 'max-w-4xl mx-auto px-4 mt-12' }, 
                    React.createElement('div', { className: 'bg-slate-800 text-slate-300 p-6 rounded-2xl text-sm' }, [
                        React.createElement('h4', { className: 'font-bold text-white mb-2' }, 'ğŸ’¡ ä½¿ç”¨å°æ’‡æ­¥'),
                        React.createElement('ul', { className: 'list-disc list-inside space-y-1' }, [
                            React.createElement('li', null, 'æœ¬ç³»çµ±åƒ…é¡¯ç¤ºç¤¾åœ˜ä¸»åç¨±ï¼ˆå»é™¤äººæ•¸èˆ‡å‚™è¨»è¨Šæ¯ï¼‰ã€‚'),
                            React.createElement('li', null, 'è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼å¿…é ˆèˆ‡å¡«å¯«å ±åè¡¨æ™‚å®Œå…¨ä¸€è‡´ã€‚'),
                            React.createElement('li', null, 'å¦‚æ¬²ä¿®æ”¹å ±åè³‡æ–™ï¼Œè«‹å…ˆåœ¨æ­¤ã€Œåˆªé™¤ã€èˆŠç´€éŒ„å¾Œé‡æ–°å ±åã€‚')
                        ])
                    ])
                )
            ]);
        };

        /**
         * ------------------------------------------------------------------
         * ã€å¾Œç«¯ Google Apps Script åƒè€ƒç¨‹å¼ç¢¼ã€‘
         * è«‹åœ¨è©¦ç®—è¡¨ä¸­é»é¸ã€Œæ“´å……åŠŸèƒ½ > Apps Scriptã€ä¸¦è²¼å…¥ä»¥ä¸‹å…§å®¹ï¼š
         * 
         * function doPost(e) {
         *   var params = JSON.parse(e.postData.contents);
         *   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("è¡¨å–®å›æ‡‰ 1");
         *   var data = sheet.getDataRange().getValues();
         *   
         *   if (params.action === "delete") {
         *     for (var i = data.length - 1; i >= 1; i--) {
         *       // æ ¹æ“š æ™‚é–“æˆ³è¨˜ èˆ‡ æ‰‹æ©Ÿè™Ÿç¢¼ åŒæ™‚æ¯”å°ç¢ºä¿åˆªé™¤æ­£ç¢ºè¡Œ
         *       if (data[i][0].toString() === params.timestamp && data[i][7].toString() === params.phoneNumber) {
         *         sheet.deleteRow(i + 1);
         *         return ContentService.createTextOutput("Deleted");
         *       }
         *     }
         *   }
         *   return ContentService.createTextOutput("No Action");
         * }
         * ------------------------------------------------------------------
         */

        ReactDOM.render(
            React.createElement(App),
            document.getElementById('root')
        );
    </script>
</body>
</html>

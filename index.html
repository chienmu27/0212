
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社團報名查詢系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto+Sans+TC', sans-serif; background-color: #f1f5f9; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState } from 'react';
        import { createRoot } from 'react-dom';
        import { Search, Trash2, Info, Loader2, User, Phone, CheckCircle2, AlertCircle, ClipboardList } from 'lucide-react';

        const SPREADSHEET_ID = '17gOPXFMR1UzS5NHOE7MV6Jbfzo1blDnkmjBksSdpCvk';
        const SHEET_NAME = '表單回應 1';
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyUjGQIYW-HJ-vm-G-F3KydEw-vU5tVcD0CCsVK2ZQl54lhuDtJXoSzSgz0IK7gTf8tHQ/exec';

        const App = () => {
            const [phoneNumber, setPhoneNumber] = useState('');
            const [results, setResults] = useState([]);
            const [status, setStatus] = useState('IDLE'); 
            const [message, setMessage] = useState('');

            // 格式化社團名稱：僅顯示 '(' 左側文字
            const formatClubName = (name) => {
                if (!name) return '';
                return name.split(/[（(]/)[0].trim();
            };

            const handleSearch = async (e) => {
                if (e) e.preventDefault();
                const phone = phoneNumber.trim();
                if (!phone) {
                    setMessage('請輸入完整手機號碼');
                    return;
                }

                setStatus('LOADING');
                setMessage('');
                
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
                    const response = await fetch(url);
                    const text = await response.text();
                    const jsonData = JSON.parse(text.substring(47, text.length - 2));
                    const rows = jsonData.table.rows;
                    
                    const records = rows.map((row, index) => {
                        const c = row.c;
                        return {
                            timestamp: c[0]?.f || c[0]?.v || '', 
                            email: c[1]?.v || '',
                            clubItem: c[2]?.v || '',
                            displayClubItem: formatClubName(c[2]?.v || ''),
                            grade: c[3]?.v || '',
                            className: c[4]?.v || '',
                            seatNumber: c[5]?.v || '',
                            studentName: c[6]?.v || '',
                            phoneNumber: String(c[7]?.v || '')
                        };
                    });

                    const filtered = records.filter(r => r.phoneNumber === phone);
                    setResults(filtered);
                    
                    if (filtered.length === 0) {
                        setMessage(`查無手機號碼「${phone}」的報名紀錄。`);
                    } else {
                        setPhoneNumber(''); // 查詢成功，清空手機號碼輸入框
                        setMessage('');
                    }
                    setStatus('SUCCESS');
                } catch (error) {
                    setStatus('ERROR');
                    setMessage('連線失敗，請檢查網路或試算表權限。');
                }
            };

            const handleDelete = async (record) => {
                if (!confirm(`確定要刪除「${record.studentName}」的「${record.displayClubItem}」報名嗎？`)) return;

                setStatus('DELETING');
                try {
                    await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        body: JSON.stringify({
                            action: 'delete',
                            timestamp: record.timestamp,
                            email: record.email,
                            clubItem: record.clubItem,
                            grade: record.grade,
                            className: record.className,
                            seatNumber: record.seatNumber,
                            studentName: record.studentName,
                            phoneNumber: record.phoneNumber
                        })
                    });
                    
                    setResults(prev => prev.filter(r => 
                        !(r.timestamp === record.timestamp && r.studentName === record.studentName && r.clubItem === record.clubItem)
                    ));
                    alert('刪除指令已送出！請稍後重新查詢以確認更新狀態。');
                } catch (error) {
                    alert('刪除失敗，請檢查網路連線。');
                }
                setStatus('SUCCESS');
            };

            return React.createElement('div', { className: 'min-h-screen pb-10' }, [
                // Header
                React.createElement('header', { className: 'bg-blue-600 text-white shadow-lg mb-8' }, 
                    React.createElement('div', { className: 'max-w-4xl mx-auto px-6 py-10 text-center' }, [
                        React.createElement(ClipboardList, { size: 40, className: 'mx-auto mb-4' }),
                        React.createElement('h1', { className: 'text-2xl font-bold' }, '社團報名紀錄查詢'),
                        React.createElement('p', { className: 'mt-1 text-blue-100' }, '輸入家長手機號碼，管理您的報名資料')
                    ])
                ),

                // Main Section
                React.createElement('main', { className: 'max-w-3xl mx-auto px-4' }, [
                    // Search box
                    React.createElement('div', { className: 'bg-white rounded-2xl p-6 card-shadow mb-8 -mt-16 relative z-10 border border-blue-50' }, 
                        React.createElement('form', { onSubmit: handleSearch, className: 'flex flex-col md:flex-row gap-3' }, [
                            React.createElement('div', { className: 'relative flex-grow' }, [
                                React.createElement(Phone, { className: 'absolute left-4 top-1/2 -translate-y-1/2 text-slate-400', size: 20 }),
                                React.createElement('input', {
                                    type: 'tel',
                                    placeholder: '手機號碼 (例如: 0912345678)',
                                    value: phoneNumber,
                                    onChange: (e) => setPhoneNumber(e.target.value),
                                    className: 'w-full pl-12 pr-4 py-4 bg-slate-50 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all'
                                })
                            ]),
                            React.createElement('button', {
                                type: 'submit',
                                disabled: status === 'LOADING',
                                className: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl flex items-center justify-center gap-2 transition-all disabled:opacity-50'
                            }, [
                                status === 'LOADING' ? React.createElement(Loader2, { className: 'animate-spin' }) : React.createElement(Search),
                                '查詢'
                            ])
                        ])
                    ),

                    // Info Message
                    message && React.createElement('div', { className: `mb-6 p-4 rounded-xl flex items-center gap-3 animate-fade-in ${status === 'ERROR' ? 'bg-red-50 text-red-600' : 'bg-amber-50 text-amber-700'}` }, [
                        React.createElement(Info, { size: 20 }),
                        React.createElement('p', { className: 'font-medium' }, message)
                    ]),

                    // List of results
                    results.length > 0 && React.createElement('div', { className: 'space-y-4 animate-fade-in' }, [
                        React.createElement('h2', { className: 'text-slate-600 font-bold px-1' }, `共有 ${results.length} 筆資料`),
                        ...results.map((record, i) => 
                            React.createElement('div', { key: i, className: 'bg-white rounded-2xl p-6 card-shadow border border-slate-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:border-blue-200 transition-all' }, [
                                React.createElement('div', { className: 'space-y-2' }, [
                                    React.createElement('div', { className: 'flex items-center gap-2' }, [
                                        React.createElement('span', { className: 'text-xs font-bold px-2 py-0.5 bg-blue-50 text-blue-600 rounded-md' }, `${record.grade}${record.className}`),
                                        React.createElement('h3', { className: 'font-bold text-slate-800 text-lg' }, record.studentName)
                                    ]),
                                    React.createElement('div', null, [
                                        React.createElement('p', { className: 'text-xs text-slate-400 font-bold mb-0.5' }, '報名項目'),
                                        React.createElement('p', { className: 'text-blue-600 font-black text-xl' }, record.displayClubItem)
                                    ]),
                                    React.createElement('p', { className: 'text-[10px] text-slate-300' }, `報名時間：${record.timestamp}`)
                                ]),
                                React.createElement('button', {
                                    onClick: () => handleDelete(record),
                                    disabled: status === 'DELETING',
                                    className: 'flex items-center gap-1 text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg font-bold transition-all border border-red-100'
                                }, [
                                    status === 'DELETING' ? React.createElement(Loader2, { size: 18, className: 'animate-spin' }) : React.createElement(Trash2, { size: 18 }),
                                    '刪除'
                                ])
                            ])
                        )
                    ])
                ]),

                // Info Footer
                React.createElement('footer', { className: 'max-w-3xl mx-auto px-4 mt-12' }, 
                    React.createElement('div', { className: 'bg-slate-800 text-slate-300 p-6 rounded-2xl text-xs space-y-2' }, [
                        React.createElement('p', { className: 'text-white font-bold mb-2 flex items-center gap-1' }, [React.createElement(Info, { size: 14 }), '注意事項']),
                        React.createElement('p', null, '1. 刪除資料將會比對時間、姓名、班級座號等全數資訊，確保刪除正確。'),
                        React.createElement('p', null, '2. 社團名稱比對採關鍵字比對 (如「直排輪」)，其餘括號後資訊不影響刪除。'),
                        React.createElement('p', null, '3. 若剛刪除完立即查詢，試算表可能需 5-10 秒進行資料同步。')
                    ])
                )
            ]);
        };

        createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
</body>
</html>

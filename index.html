<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>社團選項管理</title>
  <style>
    body{font-family:Arial,"Microsoft JhengHei",sans-serif;background:#f6f7fb;margin:0;padding:20px}
    .wrap{max-width:900px;margin:auto}
    h1{font-size:22px;margin:0 0 16px}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,button{font-size:16px;padding:10px;border-radius:10px;border:1px solid #ddd}
    input{flex:1;min-width:240px}
    button{cursor:pointer;border:none;background:#2563eb;color:#fff}
    button:hover{opacity:.9}
    .list{margin-top:12px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid #eee;border-radius:10px;margin-bottom:8px}
    .item button{background:#dc2626}
    .msg{margin-top:10px;font-size:14px;color:#444}
    .small{font-size:13px;color:#666}
    .tabs{display:flex;gap:8px;margin-bottom:16px}
    .tab{padding:10px 14px;border-radius:999px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .tab.active{background:#2563eb;color:#fff;border-color:#2563eb}
    .page{display:none}
    .page.active{display:block}
  </style>
</head>

<body>
<div class="wrap">
  <h1>社團選項管理（GitHub Pages 版）</h1>

  <div class="tabs">
    <div class="tab active" data-page="p1">管理社團選項</div>
    <div class="tab" data-page="p2">表單（嵌入）</div>
  </div>

  <!-- Page 1 -->
  <div id="p1" class="page active">
    <div class="card">
      <div class="row">
        <input id="clubInput" type="text" placeholder="輸入要新增的社團名稱">
        <button onclick="addClub()">新增</button>
        <button onclick="refreshList()">重新整理</button>
      </div>
      <div class="msg" id="msg"></div>
      <div class="list" id="list"></div>
      <div class="small">※ 刪除與新增皆會同步更新 Google 表單選項</div>
    </div>
  </div>

  <!-- Page 2 -->
  <div id="p2" class="page">
    <div class="card">
      <div class="small">這裡放你的 Google 表單嵌入碼（原功能保留）</div>
      <iframe
        src="https://docs.google.com/forms/d/e/XXXXXXXXXXXX/viewform?embedded=true"
        width="100%"
        height="900"
        frameborder="0"
        marginheight="0"
        marginwidth="0"
      >載入中…</iframe>
    </div>
  </div>

  <!-- 隱藏 iframe：用來送出 POST 避免 CORS -->
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <!-- 隱藏 form：新增 -->
  <form id="postForm" method="POST" target="hidden_iframe" style="display:none;">
    <input type="hidden" name="action" id="formAction">
    <input type="hidden" name="value" id="formValue">
  </form>

</div>

<script>
/** ⭐⭐⭐ 改成你的 GAS Web App 網址 ⭐⭐⭐ */
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyCxUmsmO3bj1bigj2_hEqX6cNHwUkUWNVEl-TspTSAc2RComMfkF3MaPDvqZKlqo0oyg/exec";

const msgEl = document.getElementById("msg");
const listEl = document.getElementById("list");
const inputEl = document.getElementById("clubInput");
const postForm = document.getElementById("postForm");
const formAction = document.getElementById("formAction");
const formValue = document.getElementById("formValue");

function setMsg(text, ok=true){
  msgEl.textContent = text || "";
  msgEl.style.color = ok ? "#166534" : "#b91c1c";
}

// =========================
// Tab 切換
// =========================
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");

    const pageId = tab.dataset.page;
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    document.getElementById(pageId).classList.add("active");
  });
});

// =========================
// 讀取清單（GET）
// =========================
async function refreshList(){
  setMsg("讀取中…");
  listEl.innerHTML = "";

  try{
    const url = GAS_WEBAPP_URL + "?action=list&t=" + Date.now();
    const res = await fetch(url);
    const data = await res.json();

    if(!data.ok){
      setMsg(data.message || "讀取失敗", false);
      return;
    }

    renderList(data.list || []);
    setMsg("讀取完成");
  }catch(err){
    setMsg("讀取失敗：" + err, false);
  }
}

function renderList(list){
  listEl.innerHTML = "";

  if(!list.length){
    listEl.innerHTML = `<div class="small">目前沒有任何社團項目</div>`;
    return;
  }

  list.forEach(name=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div>${escapeHtml(name)}</div>
      <button onclick="deleteClub('${encodeURIComponent(name)}')">刪除</button>
    `;
    listEl.appendChild(div);
  });
}

function escapeHtml(str){
  return (str+"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// =========================
// 新增（POST：用 form + iframe）
// =========================
function addClub(){
  const val = (inputEl.value || "").trim();
  if(!val){
    setMsg("請先輸入社團名稱", false);
    return;
  }

  setMsg("新增中…");

  // form 送出避免 CORS
  postForm.action = GAS_WEBAPP_URL;
  formAction.value = "add";
  formValue.value = val;

  postForm.submit();

  // 由於 iframe 無法直接拿回 response，採用延遲刷新
  setTimeout(async ()=>{
    inputEl.value = "";
    await refreshList();
    setMsg("新增完成");
  }, 1200);
}

// =========================
// 刪除（POST：用 form + iframe）
// =========================
function deleteClub(encodedName){
  const name = decodeURIComponent(encodedName);

  if(!confirm("確定要刪除：「" + name + "」？")){
    return;
  }

  setMsg("刪除中…");

  postForm.action = GAS_WEBAPP_URL;
  formAction.value = "delete";
  formValue.value = name;

  postForm.submit();

  setTimeout(async ()=>{
    await refreshList();
    setMsg("刪除完成");
  }, 1200);
}

// 初始載入
refreshList();
</script>

</body>
</html>

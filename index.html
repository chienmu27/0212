
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社團報名查詢系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto+Sans+TC', sans-serif;
            background-color: #f1f5f9;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState } from 'react';
        import { createRoot } from 'react-dom';
        import { Search, Trash2, ClipboardList, Info, AlertCircle, CheckCircle2, Loader2, User, Phone, GraduationCap } from 'lucide-react';

        // --- 設定區 ---
        const SPREADSHEET_ID = '17gOPXFMR1UzS5NHOE7MV6Jbfzo1blDnkmjBksSdpCvk';
        const SHEET_NAME = '表單回應 1';
        
        // 請確保此處為您最新的 GAS 部署網址（部署時請選擇「任何人」皆可存取）
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyrhvVgOr4tI_3PtQDJJGthYbPYdgbss3MqbxmXz9B_w_sC-0SA2B4Kk0muZ_e93DlVkA/exec';

        const App = () => {
            const [phoneNumber, setPhoneNumber] = useState('');
            const [results, setResults] = useState([]);
            const [status, setStatus] = useState('IDLE'); 
            const [message, setMessage] = useState('');

            // 格式化社團名稱：取 ( 左邊的文字
            const formatClubName = (fullName) => {
                if (!fullName) return '';
                // 處理可能包含全型或半型括號的情況
                return fullName.split(/[（(]/)[0].trim();
            };

            const handleSearch = async (e) => {
                if (e) e.preventDefault();
                const searchPhone = phoneNumber.trim();
                if (!searchPhone) {
                    setMessage('請輸入完整的手機號碼');
                    return;
                }

                setStatus('LOADING');
                setMessage('');
                
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
                    const response = await fetch(url);
                    const text = await response.text();
                    
                    // 解析 Gviz JSON
                    const jsonData = JSON.parse(text.substring(47, text.length - 2));
                    const rows = jsonData.table.rows;
                    
                    const records = rows.map((row, index) => {
                        const c = row.c;
                        return {
                            rowId: index + 1,
                            timestamp: c[0]?.f || c[0]?.v || '', // 優先取格式化後的字串以利比對
                            email: c[1]?.v || '',
                            clubItem: c[2]?.v || '',
                            displayClubItem: formatClubName(c[2]?.v || ''),
                            grade: c[3]?.v || '',
                            className: c[4]?.v || '',
                            seatNumber: c[5]?.v || '',
                            studentName: c[6]?.v || '',
                            phoneNumber: String(c[7]?.v || '')
                        };
                    });

                    const filtered = records.filter(r => r.phoneNumber === searchPhone);
                    setResults(filtered);
                    
                    if (filtered.length === 0) {
                        setMessage(`查無手機號碼為「${searchPhone}」的報名紀錄。`);
                    } else {
                        // 查詢成功後，自動清除手機號碼輸入框
                        setPhoneNumber('');
                    }
                    setStatus('SUCCESS');
                } catch (error) {
                    console.error('Fetch error:', error);
                    setStatus('ERROR');
                    setMessage('讀取資料失敗，請確認網路連線或試算表權限。');
                }
            };

            const handleDelete = async (record) => {
                if (!confirm(`確定要刪除「${record.studentName}」的「${record.displayClubItem}」報名紀錄嗎？\n此動作將同步移除試算表中的原始資料。`)) {
                    return;
                }

                setStatus('LOADING');
                try {
                    // 為了避開 CORS 預檢請求限制，我們不設定 Content-Type 標頭
                    // GAS 的 doPost 會從 e.postData.contents 取得字串
                    await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            action: 'delete',
                            timestamp: String(record.timestamp),
                            phoneNumber: record.phoneNumber,
                            studentName: record.studentName
                        })
                    });
                    
                    // 樂觀更新介面：直接從目前的結果清單中移除
                    setResults(prev => prev.filter(r => 
                        !(r.timestamp === record.timestamp && r.phoneNumber === record.phoneNumber && r.studentName === record.studentName)
                    ));
                    
                    alert('刪除請求已送出，系統正在後端進行同步更新。');
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('刪除功能暫時無法連線，請稍後再試。');
                }
                setStatus('SUCCESS');
            };

            return React.createElement('div', { className: 'min-h-screen' }, [
                // Header
                React.createElement('header', { className: 'bg-indigo-700 text-white shadow-xl' }, 
                    React.createElement('div', { className: 'max-w-4xl mx-auto px-6 py-12 text-center' }, [
                        React.createElement('div', { className: 'inline-block p-3 bg-white/10 rounded-2xl mb-4' }, 
                            React.createElement(ClipboardList, { size: 48 })
                        ),
                        React.createElement('h1', { className: 'text-4xl font-extrabold tracking-tight mb-3' }, '社團報名查詢系統'),
                        React.createElement('p', { className: 'text-indigo-100 text-lg opacity-90 font-medium' }, '管理您的報名紀錄，快速、簡單、精確')
                    ])
                ),

                // Main Content
                React.createElement('main', { className: 'max-w-4xl mx-auto px-4 -mt-8' }, [
                    // Search Card
                    React.createElement('div', { className: 'bg-white rounded-3xl shadow-xl p-8 mb-8 border border-indigo-50' }, 
                        React.createElement('form', { onSubmit: handleSearch, className: 'space-y-4' }, [
                            React.createElement('label', { className: 'block text-sm font-bold text-slate-700 mb-1 ml-1' }, '請輸入家長手機號碼'),
                            React.createElement('div', { className: 'flex flex-col md:flex-row gap-4' }, [
                                React.createElement('div', { className: 'relative flex-grow' }, [
                                    React.createElement('div', { className: 'absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400' }, 
                                        React.createElement(Phone, { size: 20 })
                                    ),
                                    React.createElement('input', {
                                        type: 'tel',
                                        placeholder: '例如: 0912345678',
                                        value: phoneNumber,
                                        onChange: (e) => setPhoneNumber(e.target.value),
                                        className: 'block w-full pl-12 pr-4 py-4 border-2 border-slate-100 rounded-2xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none text-xl transition-all font-medium placeholder:text-slate-300'
                                    })
                                ]),
                                React.createElement('button', {
                                    type: 'submit',
                                    disabled: status === 'LOADING',
                                    className: 'px-10 py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-2xl shadow-lg shadow-indigo-200 transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2'
                                }, [
                                    status === 'LOADING' ? React.createElement(Loader2, { className: 'animate-spin' }) : React.createElement(Search, { size: 22 }),
                                    '查詢紀錄'
                                ])
                            ])
                        ])
                    ),

                    // Message Area
                    message && React.createElement('div', { className: `mb-8 p-5 rounded-2xl flex items-center gap-4 animate-fade-in ${status === 'ERROR' ? 'bg-red-50 text-red-700 border border-red-100' : 'bg-amber-50 text-amber-800 border border-amber-100'}` }, [
                        status === 'ERROR' ? React.createElement(AlertCircle, { size: 24 }) : React.createElement(Info, { size: 24 }),
                        React.createElement('p', { className: 'font-semibold text-lg' }, message)
                    ]),

                    // Results
                    results.length > 0 && React.createElement('div', { className: 'space-y-6 animate-fade-in' }, [
                        React.createElement('div', { className: 'flex items-center justify-between mb-4 px-2' }, [
                            React.createElement('h2', { className: 'text-2xl font-bold text-slate-800' }, [
                                '找到 ',
                                React.createElement('span', { className: 'text-indigo-600' }, results.length),
                                ' 筆報名紀錄'
                            ]),
                        ]),
                        ...results.map((record, i) => 
                            React.createElement('div', { key: i, className: 'bg-white rounded-3xl shadow-md border border-slate-100 overflow-hidden group hover:shadow-xl transition-all duration-300' }, [
                                React.createElement('div', { className: 'p-6 flex flex-col md:flex-row md:items-center justify-between gap-6' }, [
                                    React.createElement('div', { className: 'space-y-3' }, [
                                        React.createElement('div', { className: 'flex items-center gap-2' }, [
                                            React.createElement('span', { className: 'bg-indigo-50 text-indigo-700 text-sm font-bold px-3 py-1 rounded-full flex items-center gap-1' }, [
                                                React.createElement(GraduationCap, { size: 14 }),
                                                `${record.grade}年${record.className}班 ${record.seatNumber}號`
                                            ]),
                                            React.createElement('div', { className: 'flex items-center gap-1.5 text-slate-900 font-bold text-xl ml-1' }, [
                                                React.createElement(User, { size: 18, className: 'text-slate-400' }),
                                                record.studentName
                                            ])
                                        ]),
                                        React.createElement('div', { className: 'flex flex-col' }, [
                                            React.createElement('span', { className: 'text-xs font-bold text-slate-400 uppercase tracking-wider mb-0.5' }, '報名項目'),
                                            React.createElement('span', { className: 'text-indigo-600 font-black text-3xl' }, record.displayClubItem)
                                        ]),
                                        React.createElement('div', { className: 'text-xs text-slate-400 font-medium flex items-center gap-1' }, `報名時間：${record.timestamp}`)
                                    ]),
                                    React.createElement('button', {
                                        onClick: () => handleDelete(record),
                                        disabled: status === 'LOADING',
                                        className: 'flex items-center justify-center gap-2 px-6 py-4 bg-rose-50 text-rose-600 hover:bg-rose-600 hover:text-white font-bold rounded-2xl transition-all border border-rose-100 group-hover:border-rose-200'
                                    }, [
                                        React.createElement(Trash2, { size: 20 }),
                                        '刪除資料'
                                    ])
                                ])
                            ])
                        )
                    ])
                ]),

                // Footer
                React.createElement('footer', { className: 'max-w-4xl mx-auto px-4 mt-16 mb-12' }, 
                    React.createElement('div', { className: 'bg-slate-900 text-slate-400 p-8 rounded-3xl shadow-2xl relative overflow-hidden' }, [
                        // Decorative element
                        React.createElement('div', { className: 'absolute -top-10 -right-10 w-40 h-40 bg-indigo-500/10 rounded-full blur-3xl' }),
                        
                        React.createElement('h4', { className: 'font-bold text-white text-lg mb-4 flex items-center gap-2' }, [
                            React.createElement(Info, { size: 20, className: 'text-indigo-400' }),
                            '查詢須知'
                        ]),
                        React.createElement('ul', { className: 'space-y-3 text-sm font-medium' }, [
                            React.createElement('li', { className: 'flex items-start gap-2' }, [
                                React.createElement('span', { className: 'text-indigo-500 mt-1' }, '•'),
                                '本系統僅顯示社團主標題，詳細課程細節請參閱紙本簡章。'
                            ]),
                            React.createElement('li', { className: 'flex items-start gap-2' }, [
                                React.createElement('span', { className: 'text-indigo-500 mt-1' }, '•'),
                                '刪除資料為即時操作，刪除後若需再次報名請重新填寫表單。'
                            ]),
                            React.createElement('li', { className: 'flex items-start gap-2' }, [
                                React.createElement('span', { className: 'text-indigo-500 mt-1' }, '•'),
                                '執行刪除不需重新輸入手機，系統會自動使用當前查詢成功的紀錄進行比對。'
                            ]),
                            React.createElement('li', { className: 'flex items-start gap-2 text-slate-500' }, [
                                React.createElement('span', { className: 'text-indigo-500 mt-1' }, '•'),
                                '後端同步可能存在 5-10 秒延遲，若資料未立即消失請稍後再試。'
                            ])
                        ])
                    ])
                )
            ]);
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(React.createElement(App));
    </script>
</body>
</html>
